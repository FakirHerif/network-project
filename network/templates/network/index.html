{% extends "network/layout.html" %}

{% block body %}

<script>
    function getCookie(name){
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length == 2) return parts.pop().split(';').shift();
    }

    function saveChanges(button) {
    const postId = button.getAttribute('data-post-id');
    const textAreaValue = document.getElementById(`textarea_${postId}`).value;
    const content = document.getElementById(`content_${postId}`);
    const modal = document.getElementById(`modal_edit_post_${postId}`);
    fetch(`/edit/${postId}`, {
        method: "POST",
        headers: {"Content-type": "application/json", "X-CSRFToken": getCookie("csrftoken")},
        body: JSON.stringify( {
            content: textAreaValue
        })
    })
    .then(response => response.json())
    .then(result => {
        content.innerHTML = result.data;
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        modal.setAttribute('style', 'display: none');

        const modalsBackdrops = document.getElementsByClassName('modal-backdrop');
        for(let i=0; i<modalsBackdrops.length; i++){
            document.body.removeChild(modalsBackdrops[i]);
        }
    })
}

    let whoYouLiked = [];

    function LikeHandler(id) {
    let btn = document.getElementById(`${id}`);

    if (whoYouLiked.indexOf(id) >= 0) {
        fetch(`/like_remove/${id}`)
            .then(response => response.json())
            .then(result => {
                btn.classList.remove('fa-thumbs-down');
                btn.classList.add('fa-thumbs-up'); // Like yapƒ±ldƒ±ƒüƒ±nda butonu "fa-thumbs-up" olarak deƒüi≈ütir
                // whoYouLiked dizisini g√ºncelle 
                whoYouLiked.splice(whoYouLiked.indexOf(id), 1); // Beƒüeni kaldƒ±r
            });
    } else {
        fetch(`/like_add/${id}`)
            .then(response => response.json())
            .then(result => {
                btn.classList.remove('fa-thumbs-up');
                btn.classList.add('fa-thumbs-down'); // Unlike yapƒ±ldƒ±ƒüƒ±nda butonu "fa-thumbs-down" olarak deƒüi≈ütir
                // whoYouLiked dizisini g√ºncelle
                whoYouLiked.push(id); // Beƒüeni ekle
            });
    }
}


    // Bu fonksiyon, textarea'ya tƒ±kladƒ±ƒüƒ±nƒ±zda veya odaklandƒ±ƒüƒ±nƒ±zda varsayƒ±lan metni siler
    function clearDefaultText(textarea) {
        if (textarea.value === "Write your post üòç") {
            textarea.value = "";
        }
    }

    // Bu fonksiyon, textarea odak kaybettiƒüinde ve i√ßerik bo≈üsa varsayƒ±lan metni geri ekler
    function restoreDefaultText(textarea) {
        if (textarea.value.trim() === "") {
            textarea.value = "Write your post üòç";
        }
    }

    // Bu fonksiyon, textarea bo≈üsa veya varsayƒ±lan metni i√ßeriyorsa g√∂ndermeyi engeller
    function checkEmpty(textarea) {
        if (textarea.value.trim() === "" || textarea.value === "Write your post üòç") {
            alert("Post content cannot be empty! or Post content cannot be same!");
            return false;
        }
        return true;
    }


    function deletePost(postId) {
    const confirmation = confirm("Are you sure you want to delete this post?");
    if (confirmation) {
        fetch(`/delete_post/${postId}/`, {
            method: "DELETE",
            headers: {"X-CSRFToken": getCookie("csrftoken")}
        })
        .then(response => {
            if (response.status === 200) {
                // G√∂nderi ba≈üarƒ±yla silindiƒüinde sayfayƒ± yeniden y√ºkle
                window.location.reload();
            } else if (response.status === 403) {
                alert("You are not authorized to delete this post.");
            } else {
                alert("Failed to delete post.");
            }
        })
        .catch(error => {
            console.error("An error occurred:", error);
            alert("An error occurred while deleting the post.");
        });
    }
}


    // Emoji verilerini √ßekmek i√ßin bir AJAX isteƒüi yapƒ±n
    fetch('/get_emojis/')
        .then(response => response.json())
        .then(data => {
            // Verileri alƒ±n ve modal i√ßindeki liste i√ßin kullanƒ±n
            const emojiListInModal = document.getElementById("emojiListInModal");

            // √ñrnek emoji kodlarƒ±nƒ± bir dizi i√ßinde tutun
            const emojis = [ "üòÄ", "üòÅ", "üòÇ", "ü§£", "üòÉ", "üòÑ", "üòÖ", "üòÜ", "üòâ", "üòä", "üòã", "üòé", "üòç", "üòò", "üòó", "üòô", "üòö", "‚ò∫Ô∏è", "üôÇ", "ü§ó", "ü§©", "ü§î", "ü§®", "üòê", "üòë", "üò∂", "üôÑ", "üòè", "üò£", "üò•", "üòÆ", "ü§ê", "üòØ", "üò™", "üò´", "üò¥", "üòå", "üòõ", "üòú", "üòù", "ü§§", "üòí", "üòì", "üòî", "üòï", "üôÉ", "ü§ë", "üò≤", "‚òπÔ∏è", "üôÅ", "üòñ", "üòû", "üòü", "üò§", "üò¢", "üò≠", "üò¶", "üòß", "üò®", "üò©", "ü§Ø", "üò¨", "üò∞", "üò±", "üò≥", "ü§™", "üòµ", "üò°", "üò†", "ü§¨", "üò∑", "ü§í", "ü§ï", "ü§¢", "ü§Æ", "ü§ß", "üòá", "ü§†", "ü§°", "ü§•", "ü§´", "ü§≠", "üßê", "ü§ì", "üòà", "üëø", "üëπ", "üë∫", "üíÄ", "‚ò†Ô∏è", "üëª", "üëΩ", "üëæ", "ü§ñ", "üí©", "üò∫", "üò∏", "üòπ", "üòª", "üòº", "ü§∑", "ü§∂", "ü§µ", "ü§¥", "üë∏", "üßô‚Äç‚ôÄÔ∏è", "üßô‚Äç‚ôÇÔ∏è", "üßö‚Äç‚ôÄÔ∏è", "üßö‚Äç‚ôÇÔ∏è", "üßõ‚Äç‚ôÄÔ∏è", "üßõ‚Äç‚ôÇÔ∏è", "üßú‚Äç‚ôÄÔ∏è", "üßú‚Äç‚ôÇÔ∏è", "üßù‚Äç‚ôÄÔ∏è", "üßù‚Äç‚ôÇÔ∏è", "üßû‚Äç‚ôÄÔ∏è", "üßû‚Äç‚ôÇÔ∏è", "üßü‚Äç‚ôÄÔ∏è", "üßü‚Äç‚ôÇÔ∏è", "üíÜ‚Äç‚ôÄÔ∏è", "üíÜ‚Äç‚ôÇÔ∏è", "üíá‚Äç‚ôÄÔ∏è", "üíá‚Äç‚ôÇÔ∏è", "üíÖ", "üë©‚Äçü¶Ω", "üë®‚Äçü¶Ω", "üë©‚Äçü¶º", "üë®‚Äçü¶º", "üö∂‚Äç‚ôÄÔ∏è", "üö∂‚Äç‚ôÇÔ∏è", "üèÉ‚Äç‚ôÄÔ∏è", "üèÉ‚Äç‚ôÇÔ∏è", "üêµ", "üôà", "üôâ", "üéÉ", "üéÑ", "üéÜ", "üéá", "üß®", "‚ú®", "üéà", "üéâ", "üéä", "üéã", "üéç", "üéé", "üéè", "üéê", "üéë", "üßß", "üéÅ", "üéüÔ∏è", "üé´", "üèÆ", "ü™î", "üéñÔ∏è", "üèÜ", "üèÖ", "ü•á", "ü•à", "ü•â", "‚öΩ", "‚öæ", "ü•é", "üèÄ", "üèê", "üèà", "üèâ", "üéæ", "ü•è", "üé≥", "üèè", "üèë", "üèí", "ü•ç", "üèì", "üè∏", "ü•ä", "ü•ã", "ü•Ö", "‚õ≥", "‚õ∏Ô∏è", "üé£", "ü§ø", "üéΩ", "üéø", "üõ∑", "ü•å", "üéØ", "ü™Ä", "ü™Å", "üé±", "üîÆ",  "üéÆ", "üïπÔ∏è", "üé∞", "üé≤", "üß©", "‚ô†Ô∏è", "‚ô•Ô∏è", "‚ô¶Ô∏è", "‚ô£Ô∏è", "‚ôüÔ∏è", "üÉè", "üÄÑ", "üé¥", "üé≠", "üñºÔ∏è", "üé®", "üî´", "üåç", "üåé", "üåè", "üåê", "üó∫Ô∏è", "üóæ", "üß≠", "üèîÔ∏è", "‚õ∞Ô∏è", "üåã", "üóª", "üèïÔ∏è", "üèñÔ∏è", "üèúÔ∏è", "üèùÔ∏è", "üèûÔ∏è",
            "üèüÔ∏è", "üèõÔ∏è", "üèóÔ∏è", "üß±", "üèòÔ∏è", "üèöÔ∏è", "üè†", "üè°", "üè¢", "üè£", "üè§", "üè•", "üè¶", "üè®", "üè©", "üè™", "üè´", "üè¨", "üè≠", "üèØ", "üè∞", "üíí", "üóº", "üóΩ", "‚õ™", "üïå", "üõï", "üïç", "‚õ©Ô∏è", "üïã", "‚õ≤", "‚õ∫", "üåÅ", "üåÉ", "üèôÔ∏è", "üåÑ", "üåÖ", "üåÜ", "üåá", "üåâ", "‚ô®Ô∏è", "üé†", "üé°", "üé¢", "üíà", "üé™", "üõéÔ∏è", "üóø",
            "üöÇ", "üöÉ", "üöÑ", "üöÖ", "üöÜ", "üöá", "üöà", "üöâ", "üöä", "üöù", "üöû", "üöã", "üöå", "üöç", "üöé", "üöê", "üöë", "üöí", "üöì", "üöî", "üöï", "üöñ", "üöó", "üöò", "üöô", "üöö", "üöõ", "üöú", "üèéÔ∏è", "üèçÔ∏è", "üõµ", "ü¶Ω", "ü¶º", "üõ∫", "üö≤", "üõ¥", "üõπ", "üöè", "üõ£Ô∏è", "üõ§Ô∏è", "üõ¢Ô∏è", "‚õΩ", "üö®", "üö•", "üö¶", "üõë", "üöß",
            "‚öì", "‚õµ", "üõ∂", "üö§", "üõ≥Ô∏è", "‚õ¥Ô∏è", "üõ•Ô∏è", "üö¢", "‚úàÔ∏è", "üõ©Ô∏è", "üõ´", "üõ¨", "ü™Ç", "üí∫", "üöÅ", "üöü", "üö†", "üö°", "üõ∞Ô∏è", "üöÄ", "üõ∏", "üéÄ", "üéóÔ∏è", "üëì", "üï∂Ô∏è", "ü•Ω", "ü•º", "ü¶∫", "üëî", "üëï", "üëñ", "üß£", "üß§", "üß•", "üß¶", "üëó", "üëò", "ü•ª", "ü©±", "ü©≤", "ü©≥", "üëô", "üëö", "üëõ", "üëú", "üëù", "üõçÔ∏è", "üéí", "üëû", "üëü", "ü•æ", "ü•ø", "üë†", "üë°", "ü©∞", "üë¢", "üëë", "üëí", "üé©", "üéì", "üß¢", "‚õëÔ∏è", "üìø", "üíÑ", "üíç", "üíé", "ü¶Ø",
            "üîá", "üîà", "üîâ", "üîä", "üì¢", "üì£", "üìØ", "üîî", "üîï", "üéº", "üéµ", "üé∂", "üéôÔ∏è", "üéöÔ∏è", "üéõÔ∏è", "üé§", "üéß", "üìª", "üé∑", "üé∏", "üéπ", "üé∫", "üéª", "ü™ï", "ü•Å",
            "üì±", "üì≤", "‚òéÔ∏è", "üìû", "üìü", "üì†", "üîã", "üîå", "üíª", "üñ•Ô∏è", "üñ®Ô∏è", "‚å®Ô∏è", "üñ±Ô∏è", "üñ≤Ô∏è", "üíΩ", "üíæ", "üíø", "üìÄ", "üé•", "üéûÔ∏è", "üìΩÔ∏è", "üé¨", "üì∫", "üì∑", "üì∏", "üìπ", "üìº",
            "üìî", "üìï", "üìñ", "üìó", "üìò", "üìô", "üìö", "üìì", "üìí", "üìÉ", "üìú", "üìÑ", "üì∞", "üóûÔ∏è", "üìë", "üîñ", "üè∑Ô∏è", "‚úâÔ∏è", "üìß", "üì®", "üì©", "üì§", "üì•", "üì¶", "üì´", "üì™", "üì¨", "üì≠", "üìÆ", "üó≥Ô∏è", "‚úèÔ∏è", "‚úíÔ∏è", "üñãÔ∏è", "üñäÔ∏è", "üñåÔ∏è", "üñçÔ∏è", "üìù", "üíº", "üìÅ", "üìÇ", "üóÇÔ∏è", "üìÖ", "üìÜ", "üóíÔ∏è", "üóìÔ∏è", "üìá", "üìà", "üìâ", "üìä", "üìã", "üìå", "üìç", "üìé", "üñáÔ∏è", "üìè", "üìê", "‚úÇÔ∏è", "üóÉÔ∏è", "üóÑÔ∏è", "üóëÔ∏è",
            "‚åõ", "‚è≥", "‚åö", "‚è∞", "‚è±Ô∏è", "‚è≤Ô∏è", "üï∞Ô∏è", "üïõ", "üïß", "üïê", "üïú", "üïë", "üïù", "üïí", "üïû", "üïì", "üïü", "üïî", "üï†", "üïï", "üï°", "üïñ", "üï¢", "üïó", "üï£", "üïò", "üï§", "üïô", "üï•", "üïö", "üï¶", "üßÆ", "üí∞", "üí¥", "üíµ", "üí∂", "üí∑", "üí∏", "üí≥", "üßæ", "üíπ",
            "üí£", "üß≥", "üå°Ô∏è", "üß∏", "üß∂", "üîç", "üîé", "üïØÔ∏è", "üí°", "üî¶", "üîí", "üîì", "üîè", "üîê", "üîë", "üóùÔ∏è", "üî®", "ü™ì", "‚õèÔ∏è", "‚öíÔ∏è", "üõ†Ô∏è", "üó°Ô∏è", "‚öîÔ∏è", "üèπ", "üõ°Ô∏è", "üîß", "üî©", "‚öôÔ∏è", "üóúÔ∏è", "‚öñÔ∏è", "üîó", "‚õìÔ∏è", "üß∞", "üß≤", "‚öóÔ∏è", "üß™", "üß´", "üî¨", "üî≠", "üì°", "üíâ", "ü©π", "ü©∫", "üö™", "üõèÔ∏è", "üõãÔ∏è", "ü™ë", "üöΩ", "üöø", "üõÅ", "ü™í", "üß¥", "üß∑", "üßπ", "üß∫", "üßª", "üßº", "üßΩ", "üßØ",
            "üßØ", "üõí", "üèÅ", "üö©", "üéå", "üè¥", "üè≥Ô∏è", "üè≥Ô∏è‚Äçüåà", "üè≥Ô∏è‚Äç‚ößÔ∏è", "üè¥‚Äç‚ò†Ô∏è",];


        // Her emoji i√ßin d√∂ng√º olu≈üturun
        emojis.forEach(emoji => {
            const listItem = document.createElement("li");
            listItem.textContent = emoji;
            listItem.addEventListener("click", () => addEmojiToTextarea(emoji));
            emojiListInModal.appendChild(listItem);
        });

            // API'den gelen emoji listesini ekle
            data.emojis.forEach(emoji => {
                const listItem = document.createElement("li");
                listItem.textContent = `${emoji.character}`;
                listItem.addEventListener("click", () => addEmojiToTextarea(emoji.character));
                emojiListInModal.appendChild(listItem);
            });
        })
        .catch(error => {
            console.error("API'den veri alƒ±namadƒ±:", error);
        });

    // Se√ßilen emojiyi textarea'ya eklemek i√ßin i≈ülev
    function addEmojiToTextarea(emoji) {
        const textarea = document.getElementById("postContent");
        const emojiListInModal = document.getElementById("emojiListInModal");

    // Emojiye tƒ±kladƒ±ƒüƒ±nƒ±zda animasyonu ba≈ülatƒ±n
    emojiListInModal.style.pointerEvents = "none"; // Diƒüer tƒ±klamalarƒ± engellemek i√ßin
    emojiListInModal.style.opacity = "0.5"; // Opaklƒ±ƒüƒ± d√º≈ü√ºr√ºn

    // Mevcut metni ve se√ßilen emojiyi birle≈ütirin
    const currentText = textarea.value;
    const newText = currentText === "Write your post üòç" ? emoji : currentText + emoji;
    textarea.value = newText;

    // 200 milisaniye sonra animasyonu geri alƒ±n
    setTimeout(() => {
        emojiListInModal.style.pointerEvents = "auto"; // Diƒüer tƒ±klamalarƒ± tekrar etkinle≈ütirin
        emojiListInModal.style.opacity = "1"; // Opaklƒ±ƒüƒ± geri alƒ±n
    }, 200);
}


</script>


    <div id="body">
        <h1 style="font-family:fantasy">ALL POSTS</h1>
        <br>
        {% if user.is_authenticated %}
            <h2 style="font-family:fantasy">New Post</h2>
            <form action="{% url 'addPost' %}" method="POST" onsubmit="return checkEmpty(this.content)">
                {% csrf_token %}
                <textarea name="content" id="postContent" style="font-size: 30px; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;" onclick="clearDefaultText(this)" onblur="restoreDefaultText(this)" oninput="checkDefaultText(this)">Write your post üòç</textarea>
                <br>
                <input type="submit" name="" id="" class="sendButton" value="Send">
                <button type="button" class="emojiButton" data-toggle="modal" data-target="#emojiModal">
                    Emoji List
                </button>
                
                <!-- Modal -->
                <div class="modal fade" id="emojiModal" tabindex="-1" role="dialog" aria-labelledby="emojiModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="emojiModalLabel" style="font-family: fantasy; font-size: 30px;">Emoji List</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <ul id="emojiListInModal">
                                </ul>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </form> 
            <br>
            <br>
            <br> 
        {% else %} 
        <p>You are not logged in, please <a href="{% url 'login' %}">log in</a> or <a href="{% url 'register' %}">register</a> to see more content and share posts.</p>
               
        {% endif %}
    

        {% for post in page_obj %}
        
            <div class="allPosts">
                <h6 class="content" id="content_{{ post.id }}">{{ post.content }}</h6>
                <br>
                <h5 class="username"><a style="color: red; font-weight: bold; font-family:cursive" href="{% url 'profile' user_id=post.user.id %}">#{{ post.user }}</a></h5>
                <p class="date">on {{ post.date }}</p>
                {% if user.is_authenticated %}
                    {% if user == post.user %}
                    

                            <button class="btn btn-danger" id="deleteButton" onclick="deletePost(`{{ post.id }}`)">Delete</button>
                            <button class="btn btn-primary" id="editButton" data-toggle="modal" data-target="#modal_edit_post_{{ post.id }}">Edit</button>
                        
                        <div class="modal fade" id="modal_edit_post_{{ post.id }}" tabindex="-1" role="dialog" aria-labelledby="modal_edit_post_{{ post.id }}_label" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h5 class="modal-title">Edit</h5>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                  <textarea name="content" id="textarea_{{ post.id }}" cols="30" rows="5" class="form-control">{{ post.content }}</textarea>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-primary" data-post-id="{{ post.id }}" onclick="saveChanges(this)">Save changes</button>
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                              </div>
                            </div>
                          </div>
                    {% else %}
                    <br>
                        {% if post.id in whoYouLiked %}
                        <button class="btn btn-success fa fa-thumbs-down" id="{{ post.id }}" onclick="LikeHandler(`{{ post.id }}`, `{{ whoYouLiked }}`)"></button>
                        {% else %}
                        <button class="btn btn-success fa fa-thumbs-up" id="{{ post.id }}" onclick="LikeHandler(`{{ post.id }}`, `{{ whoYouLiked }}`)"></button>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    


    <nav aria-label="Page navigation example">
        <ul class="pagination">

            {% if page_obj.has_previous %}

                <li class="page-item"><a class="page-link" href="?page=1">&laquo; first</a></li>

                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>

            {% endif %}

                <li class="page-item"><a href="" class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</a></li>

            {% if page_obj.has_next %}

                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>

                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a></li>
                <br>
                <br>

            {% endif %}
        </ul>
      </nav>
    </div>
{% endblock %}